name: Release

# Trigger this workflow manually from the Actions tab or automatically on push to main with version tags
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0, v1.2.3)'
        required: true
        type: string
      update_latest:
        description: 'Update "latest" tag for development usage'
        required: false
        type: boolean
        default: true
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write  # Required for creating releases and pushing tags

jobs:
  # =============================================================================
  # Validation - Ensure version format and repository state
  # =============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      version_without_v: ${{ steps.validate.outputs.version_without_v }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history and tags
          fetch-tags: true

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Ensure version starts with 'v'
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "   Expected format: v<major>.<minor>.<patch> (e.g., v1.0.0, v1.2.3-beta.1)"
            exit 1
          fi

          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "‚ùå Tag $VERSION already exists!"
            echo "   Use a different version number or delete the existing tag first"
            exit 1
          fi

          # Extract version without 'v' prefix
          VERSION_WITHOUT_V="${VERSION#v}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_without_v=$VERSION_WITHOUT_V" >> $GITHUB_OUTPUT
          echo "‚úÖ Version $VERSION is valid and available"

  # =============================================================================
  # Quality Checks - Run full CI suite before release
  # =============================================================================
  quality:
    name: Quality Checks
    needs: validate
    uses: ./.github/workflows/terraform-ci.yml

  # =============================================================================
  # Create Release - Tag, generate changelog, create GitHub release
  # =============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, quality]
    env:
      VERSION: ${{ needs.validate.outputs.version }}
      VERSION_WITHOUT_V: ${{ needs.validate.outputs.version_without_v }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get previous tag
        id: previous_tag
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "previous_tag=" >> $GITHUB_OUTPUT
            echo "üìù No previous tag found - this is the first release"
          else
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "üìù Previous tag: $PREVIOUS_TAG"
          fi

      - name: Generate changelog
        id: changelog
        run: |
          echo "## Changes in $VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          if [ -n "${{ steps.previous_tag.outputs.previous_tag }}" ]; then
            echo "### Commits since ${{ steps.previous_tag.outputs.previous_tag }}" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md

            # Group commits by type (feat, fix, docs, etc.)
            echo "#### Features" >> RELEASE_NOTES.md
            git log ${{ steps.previous_tag.outputs.previous_tag }}..HEAD --pretty=format:"- %s (%h)" --grep="^feat" >> RELEASE_NOTES.md || echo "_No new features_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md

            echo "#### Bug Fixes" >> RELEASE_NOTES.md
            git log ${{ steps.previous_tag.outputs.previous_tag }}..HEAD --pretty=format:"- %s (%h)" --grep="^fix" >> RELEASE_NOTES.md || echo "_No bug fixes_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md

            echo "#### Documentation" >> RELEASE_NOTES.md
            git log ${{ steps.previous_tag.outputs.previous_tag }}..HEAD --pretty=format:"- %s (%h)" --grep="^docs" >> RELEASE_NOTES.md || echo "_No documentation changes_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md

            echo "#### All Changes" >> RELEASE_NOTES.md
            git log ${{ steps.previous_tag.outputs.previous_tag }}..HEAD --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          else
            echo "### Initial Release" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "This is the first release of digitact-tfm-modules." >> RELEASE_NOTES.md
          fi

          echo "" >> RELEASE_NOTES.md
          echo "---" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/commits/$VERSION" >> RELEASE_NOTES.md

      - name: Create annotated tag
        run: |
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
          echo "‚úÖ Created and pushed tag: $VERSION"

      - name: Update 'latest' tag (if requested)
        if: ${{ github.event.inputs.update_latest == 'true' }}
        run: |
          echo "‚ö†Ô∏è  Updating 'latest' tag to point to $VERSION"
          echo "   This is a moving tag - not recommended for production use!"

          # Delete existing latest tag (local and remote)
          git tag -d latest 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

          # Create new latest tag
          git tag -a latest -m "Latest release: $VERSION"
          git push origin latest --force

          echo "‚úÖ Updated 'latest' tag to $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: true  # GitHub will add additional notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## üéâ Release $VERSION Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: [$VERSION](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.update_latest }}" = "true" ]; then
            echo "- **Latest Tag**: Updated ‚úÖ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Latest Tag**: Not updated" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
            echo "- **Pre-release**: Yes ‚ö†Ô∏è" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reference this release in your Terraform code:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`hcl" >> $GITHUB_STEP_SUMMARY
          echo "module \"naming\" {" >> $GITHUB_STEP_SUMMARY
          echo "  source = \"github.com/${{ github.repository }}//labelling?ref=$VERSION\"" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "  product     = \"whub\"" >> $GITHUB_STEP_SUMMARY
          echo "  environment = \"prd\"" >> $GITHUB_STEP_SUMMARY
          echo "  application = \"api\"" >> $GITHUB_STEP_SUMMARY
          echo "  # ..." >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
